# 영속성컨섹트와 더티체킹

![영속성컨텍스트](https://user-images.githubusercontent.com/89888075/155271381-5c99955c-5415-46cd-b29d-b763c7df0683.png)

클라이언트로부터 서버(컨트롤러가) 요청과 응답을 받고 요청과응답에는 Isert,update,delete,select를 한다.
그리고 DB에는 유저라는 테이블과 유저1,2,3이 있다.

## 영속화, flush

- 영속화란<br>
  컨트롤러와 DB중간에서  JPA가있고 JPA중에 영속성컨텍스트가있는데 컨트롤러에서 유저객체를 하나 새로만들고 save를하고 DB에 Insert를 하면 **영속성컨텍스트안에 1차캐시라는 곳에 user객체가 생기는데 이를 영속화 되었다.고한다.**

- flush란<br>
  1차캐시안에 영속화된 user객체를 DB의 User테이블에 넣는것을 flush라고 한다.
  그리고 영속화된 user는 flush를 할때 사라지지않고, 컨트롤에서 유저를 select 할때 DB에서 가져오는것이아니라 user가 영속화 되어있는지 확인하고 영속화되어있는 것이있으면 그것을 가져와서 select를 한다.



## 더티체킹(Dirty Checking)
 - 더티체킹이란 상태 변경 검사다.<br>
   JPA에서는 트랜잭션이 끝나는  시점에 변화가 있는 모든 엔티티 객체를 데이트베이스에 반영한다.
   따라사 값을 변경한되,save를 따로 하지않아도 DB에 반영된다.<br>
   그리고 더티체킹은 영속성 컨텍스트에서 영속화된 객체만 적용된다.
- 더티체킹 원리
  - 서버와 DB사이의 JPA의 영속성컨텍스트가 존재 한다.
  - JPA는 엔티티를 영속성 컨텍스트에 보관할 때, 엔티티객체의 최근 상태를 영속화 시켜 관리한다.
  - 트랜잭션이 끝나고 flush를 할 때 최근상태의 영속화된 객체와 현재 엔티티를 비교해 변경된 엔티티를 찾아낸다.
  - 그리고 JPA가 변경된 엔티티를 DB단에 반영 하여 한번에 쿼리문을 날려 저장한다.